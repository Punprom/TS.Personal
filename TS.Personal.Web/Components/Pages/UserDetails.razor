@page "/users/profile/{UserId}"
@using MediatR
@using Microsoft.AspNetCore.Identity
@using TS.Personal.Core.Dtos
@using TS.Personal.Web.Extensions
@using TS.Personal.Web.Helpers
@using TS.Personal.Web.UseCases
@using TS.Personal.Web.ViewModels
@using System.IO
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer

@attribute [Authorize]

@inject IMediator Mediator
@inject IWebHostEnvironment Env
@inject NavigationManager Navigation

<PageTitle>User Profile</PageTitle>

<h1>User Profile</h1>

<div class="row mt-3">
    <EditForm Model="UserProfile" asp-route-returnUrl="@ReturnUrl" method="post" OnValidSubmit="UpdateUser"
              FormName="EditProfile">
        <div class="col-md-6 mt-3">
            <h2>Profile Information</h2>
        </div>
        <div class="mb-3" />
        <div class="col-md-6">
            <div class="form-floating mb-3">
                <InputText @bind-Value="UserProfile.Email" id="Email" class="form-control"
                           autocomplete="firstname" aria-required="true" placeholder="email" />
                <label class="lbcss" for="Email">email</label>
                <ValidationMessage For="() => UserProfile.Email" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText @bind-Value="UserProfile.FirstName" id="FirstName" class="form-control"
                           autocomplete="firstname" aria-required="true" placeholder="first name" />
                <label class="lbcss" for="FirstName">First Name</label>
                <ValidationMessage For="() => UserProfile.FirstName" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText @bind-Value="UserProfile.LastName" id="LastName" class="form-control"
                           autocomplete="LastName" aria-required="true" placeholder="last name" />
                <label class="lbcss" for="LastName">Last Name</label>
                <ValidationMessage For="() => UserProfile.LastName" class="text-danger" />
            </div>

            <div class="form-floating mb-3">
                <InputDate TValue="DateTime" @bind-Value="UserProfile.DateOfBirth" id="UserProfile.DateOfBirth" class="form-control" />
                <label class="lbcss" for="UserProfile.DateOfBirth">Date of Birth</label>
                <ValidationMessage For="() => UserProfile.DateOfBirth" class="text-danger" />
            </div>

            <div class="form-floating mb-3 col-md-5 sm-5">
                <InputText @bind-Value="UserProfile.Gender" id="PhoneNumber" class="form-control"
                           autocomplete="gender" aria-required="true" />
                <label class="lbcss" for="Gender">Gender</label>
            </div>

            <div class="form-floating mb-3 col-md-5 sm-5">
                <InputText @bind-Value="UserProfile.PhoneNumber" id="PhoneNumber" class="form-control"
                           autocomplete="phoneNumber" aria-required="true" />
                <label class="lbcss" for="PhoneNumber">Phone Number</label>
            </div>
            <button type="submit" class="w-50 btn btn-md btn-primary">Update Profile</button>
        </div>


    </EditForm>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <h2>Profile Avatar/Photo</h2>
        <div class="col-md-12 col-sm-12 mt-3 mb-3">
            <div class="col-md-5 sm-5">
                <img src="@imgSrc" class="rounded mx-auto d-block" alt="Profile Image">
            </div>
            <div class="form-floating mb-3 mt-2 col-md-7">
                <InputFile OnChange="OnFileSelected" id="Input_ProfileImage" class="form-control" accept="image/jpeg,image/png,image/gif" />
                <label class="lbcss" for="Input_ProfileImage">Image jpeg, gif max. 5MB</label>
            </div>
            <div class="col-md-5 sm-5">
                <button type="button" class="w-50 btn btn-md btn-primary" @onclick="OnSavingImageAsync">Save Image</button>
            </div>
            
        </div>
    </div>


</div>

@code {

    
    [Parameter]
    public string UserId { get; set; }

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private UserProfileVm UserProfile = new();

    private IEnumerable<IdentityError>? identityErrors;

    private byte[]? uploadedImage = new byte[0];

    private string imgSrc = "/img/blank_img.jpg";

    protected override async Task OnInitializedAsync()
    {
        // Redirect to home if UserId not provided
        if (string.IsNullOrWhiteSpace(UserId))
        {
            Navigation.NavigateTo(ReturnUrl ?? "/");
            return;
        }

        await GetUserProfileAsync();
        await SetupUserPhotoImageAsync();
    }

    private async Task GetUserProfileAsync()
    {
        var command = new GetUserRequest(UserId);
        var result = await Mediator.Send(command);

        if (result is not null)
        {
            var vm = new UserProfileVm
            {
                UserId = result.Profile.Id,
                Email = result.Profile.Email,
                Gender = result.Profile.Gender,
                FirstName = result.Profile.FirstName,
                LastName = result.Profile.LastName,
                PhoneNumber = result.Profile.PhoneNumber,
                RegisteredDate = result.Profile.RegisteredDate

            };
            UserProfile = vm;
        }
    }

    private async Task SetupUserPhotoImageAsync()
    {
        try
        {
            byte[]? data = null;
                        
            if (uploadedImage is not null && uploadedImage.Length > 0)
            {
                data = uploadedImage;
            }
            else
            {
                var command = new GetUserImageRequest(UserId);
                var dataImage = await Mediator.Send(command);
                if (dataImage is not null)
                {
                    data = dataImage.ImageData;
                    uploadedImage = data;
                }
            }

            if (data is null || data.Length == 0)
            {
                imgSrc = "/img/blank_img.jpg";
                StateHasChanged();
                return;
            }

            // ensure img folder exists in wwwroot
            var imgFolder = Path.Combine(Env.WebRootPath, "img");
            Directory.CreateDirectory(imgFolder);

            var ext = DetectImageExtension(data);
            // sanitize and build filename
            var safeName = string.IsNullOrWhiteSpace(UserProfile.FirstName) ? "user" : SanitizeFileName(UserProfile.FirstName);
            var idPart = string.IsNullOrWhiteSpace(UserId) ? Guid.NewGuid().ToString("N") : SanitizeFileName(UserId);
            var fileName = $"{safeName}_{idPart}_{DateTime.UtcNow.Ticks}{ext}";
            var filePath = Path.Combine(imgFolder, fileName);

            await File.WriteAllBytesAsync(filePath, data);

            imgSrc = $"/img/{fileName}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            identityErrors = new[] { new IdentityError { Description = $"An error occurred while creating image file: {ex.Message}" } };
        }
    }

    private static string DetectImageExtension(byte[] data)
    {
        if (data.Length >= 4 && data[0] == 0x89 && data[1] == 0x50 && data[2] == 0x4E && data[3] == 0x47)
        {
            return ".png";
        }

        if (data.Length >= 3 && data[0] == 0xFF && data[1] == 0xD8 && data[2] == 0xFF)
        {
            return ".jpg";
        }

        if (data.Length >= 3 && data[0] == 0x47 && data[1] == 0x49 && data[2] == 0x46)
        {
            return ".gif";
        }

        return ".jpg";
    }

    private static string SanitizeFileName(string input)
    {
        foreach (var c in Path.GetInvalidFileNameChars())
        {
            input = input.Replace(c, '_');
        }

        return input;
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null)
        {
            return;
        }

        const long maxAllowedSize = 1024 * 1024 * 5; // 5 MB

        if (file.Size == 0)
        {
            identityErrors = new[] { new IdentityError { Description = "Selected file is empty." } };
            return;
        }

        if (file.Size > maxAllowedSize)
        {
            identityErrors = new[] { new IdentityError { Description = "File size exceeds the 5MB limit." } };
            return;
        }

        try
        {
            var streams = await ImageCreator.CreateImageFromStreamAsync(file);
            uploadedImage = streams.FirstOrDefault()?.ToArray();
            // preview immediately by writing to disk (optional) or just set imgSrc using a data URL
            // we'll write to wwwroot after saving; show temporary preview if bytes available
            if (uploadedImage is not null && uploadedImage.Length > 0)
            {
                // create temporary preview URL using a data URI (keeps client updated)
                var base64 = Convert.ToBase64String(uploadedImage);
                var ext = DetectImageExtension(uploadedImage);
                var mime = ext switch { ".png" => "image/png", ".gif" => "image/gif", _ => "image/jpeg" };
                imgSrc = $"data:{mime};base64,{base64}";
            }
        }
        catch (Exception ex)
        {
            identityErrors = new[] { new IdentityError { Description = $"An error occurred while processing the file: {ex.Message}" } };
        }
    }

    private async Task OnSavingImageAsync()
    {
        if (uploadedImage is null || uploadedImage.Length == 0)
        {
            identityErrors = new[] { new IdentityError { Description = "No image uploaded." } };
            return;
        }

        try
        {
            var command = new UpdateUserPhotoRequest(UserId, uploadedImage);
            var response = await Mediator.Send(command);

            if (!response.Success)
            {
                identityErrors = new[] { new IdentityError { Description = "Failed to update profile image." } };
                return;
            }

            // after successful save, create file in wwwroot/img and update imgSrc
            await SetupUserPhotoImageAsync();
        }
        catch (Exception ex)
        {
            identityErrors = new[] { new IdentityError { Description = $"An error occurred while saving the image: {ex.Message}" } };
        }
    }


    private async Task UpdateUser(EditContext editContext)
    {
        var dto = UserProfile.ToDto();

        var command = new UpdateUserProfileRequest(dto);
        var response = await Mediator.Send(command);

        if (!response.Success)
        {
            identityErrors = new[] { new IdentityError { Description = $"FAILED to update user's profile!" } };
            return;
        }

        // On success, redirect to ReturnUrl if provided, otherwise to home
        Navigation.NavigateTo(ReturnUrl ?? "/");
    }

}
